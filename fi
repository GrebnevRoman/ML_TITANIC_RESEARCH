CREATE TEMPORARY VIEW all_dates AS (
  SELECT 
    batch_id, 
    feed_bin, 
    explode(sequence(start_date, COALESCE(end_date, next_start_date, current_date()), interval 1 day)) AS consumption_date
  FROM (
    SELECT 
      batch_id,
      feed_bin,
      start_date,
      end_date,
      LEAD(start_date) OVER (PARTITION BY batch_id, feed_bin ORDER BY start_date) AS next_start_date
    FROM feedConsumption_l
    JOIN feedConsumption_l_all_ln_bs ON feedConsumption_l.feedConsumption_l_hk = feedConsumption_l_all_ln_bs.feedConsumption_l_hk
    WHERE feedConsumption_l_all_ln_bs.currec = 1
  ) subquery
);

CREATE TEMPORARY VIEW feed_consumption_per_day AS (
  SELECT 
    all_dates.batch_id,
    all_dates.feed_bin,
    all_dates.consumption_date,
    amount / DATEDIFF(COALESCE(end_date, next_start_date, current_date()), start_date) AS consumption_per_day,
    unit_iso_code AS unit_of_weight
  FROM all_dates
  JOIN (
    SELECT 
      feedConsumption_l.batch_id,
      feedConsumption_l.feed_bin,
      feedConsumption_l.start_date,
      feedConsumption_l.end_date,
      feedConsumption_l_all_ln_bs.amount,
      feedConsumption_l_all_ln_bs.unit_iso_code,
      LEAD(feedConsumption_l.start_date) OVER (PARTITION BY feedConsumption_l.batch_id, feedConsumption_l.feed_bin ORDER BY feedConsumption_l.start_date) AS next_start_date
    FROM feedConsumption_l
    JOIN feedConsumption_l_all_ln_bs ON feedConsumption_l.feedConsumption_l_hk = feedConsumption_l_all_ln_bs.feedConsumption_l_hk
    WHERE feedConsumption_l_all_ln_bs.currec = 1
  ) subquery ON all_dates.batch_id = subquery.batch_id AND all_dates.feed_bin = subquery.feed_bin AND all_dates.consumption_date BETWEEN subquery.start_date AND COALESCE(subquery.end_date, subquery.next_start_date, current_date())
);

SELECT 
  batch_id,
  feed_bin,
  consumption_date,
  consumption_per_day,
  unit_of_weight
FROM feed_consumption_per_day;
